@using System.Security.Claims
@using System.Globalization
@using Dental_Clinic_System.Helper
@model Dental_Clinic_System.ViewModels.PatientVM
@{
    ViewData["Title"] = "Thông tin bệnh nhân";
    var appointments = ViewBag.Appointment as List<Dental_Clinic_System.Models.Data.Appointment>;
    int index = 1; // Initialize the counter
}


<head>
    <meta name="description" content="Đây là nơi bạn có thể xem và điều chỉnh các thông tin cá nhân của chính mình">
    <link rel="stylesheet" href="~/assets/css/mobiscroll.javascript.min.css" />
    <link rel="stylesheet" href="~/assets/css/schedule.css" />
    <link rel="stylesheet" href="~/assets/css/profile.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>
    <main>
        <div class="profile">
            <div class="d-flex">
                <ul class="nav sidebar">
                    <li>
                        <a class="nav-link active" data-bs-toggle="tab" href="#account">Quản lý tài khoản</a>
                    </li>
                    @if (User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == false)
                    {
                        <li>
                            <a class="nav-link" data-bs-toggle="tab" href="#repass">Đổi mật khẩu</a>
                        </li>
                    }
                    <li>
                        <a class="nav-link" data-bs-toggle="tab" href="#history">Lịch sử đặt khám</a>
                    </li>
                </ul>
                <div class="profile__content tab-content">
                    <div id="account" class="tab-pane fade show active">
                        <h2>Quản lý tài khoản</h2>
                        @if (TempData["ChangePasswordMessageSuccessfully"] != null)
                        {
                            <div class="alert alert-success">
                                @TempData["ChangePasswordMessageSuccessfully"]
                            </div>
                        }

                        @if (TempData["ChangePasswordMessageFailed"] != null)
                        {
                            <div class="alert alert-danger">
                                @TempData["ChangePasswordMessageFailed"]
                            </div>
                        }

                        @if (TempData["EmailError"] != null)
                        {
                            <div class="alert alert-danger">
                                @TempData["EmailError"]
                            </div>
                        }

                        @if (TempData["PhoneNumberError"] != null)
                        {
                            <div class="alert alert-danger">
                                @TempData["PhoneNumberError"]
                            </div>
                        }

                        @if (TempData["EmailChangeMessage"] != null)
                        {
                            <div class="alert alert-info">
                                @TempData["EmailChangeMessage"]
                            </div>
                        }

                        <div class="profile__warn">(*) Thông tin bắt buộc nhập</div>
                        <form asp-action="profile" method="POST" class="d-flex account__content__wrapper">

                            <div style="width: 50%">
                                <label for="firstname">Họ</label><br /><input type="text"
                                                                              id="firstname"
                                                                              placeholder="Họ"
                                                                              value="@Model.FirstName"
                                                                              asp-for="@Model.FirstName"
                                                                              style="width: 100%" />
                                <span class="text-danger" asp-validation-for="FirstName"></span>
                            </div>
                            <div style="width: 50%">
                                <label for="lastname">Tên</label><br /><input type="text"
                                                                              id="lastname"
                                                                              placeholder="Tên"
                                                                              value="@Model.LastName"
                                                                              asp-for="@Model.LastName"
                                                                              style="width: 100%" />
                                <span class="text-danger" asp-validation-for="LastName"></span>
                            </div>
                            <div style="width: 50%">
                                <label for="phone">Số điện thoại</label><br /><input type="text"
                                                                                     id="phone"
                                                                                     placeholder="Vui lòng nhập số điện thoại ..."
                                                                                     pattern="[0-9]*"
                                                                                     value="@Model.PhoneNumber"
                                                                                     asp-for="@Model.PhoneNumber"
                                                                                     style="width: 100%" />
                                <span class="text-danger" asp-validation-for="PhoneNumber"></span>

                            </div>
                            <div style="width: 50%">
                                <label for="gender">Giới tính</label><br />
                                <select id="gender" asp-for="@Model.Gender" style="width: 100%">

                                    @* Tạo các thẻ option động bằng Razor *@
                                    @if (Model.Gender == "Nam")
                                    {
                                        <option value=null disabled>Chọn giới tính ...</option>
                                        <option value="Nam" selected>Nam</option>
                                        <option value="Nữ">Nữ</option>
                                    }
                                    else if (Model.Gender == "Nữ")
                                    {
                                        <option value=null disabled>Chọn giới tính ...</option>
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ" selected>Nữ</option>
                                    }
                                    else
                                    {
                                        <option value=null disabled selected>Chọn giới tính ...</option>
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ">Nữ</option>
                                    }
                                </select>
                            </div>
                            @if (User.Identity.IsAuthenticated && ((User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == true) || (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "IsLinkedWithGoogle") == true)
                            {
                                <div style="width: 50%">
                                    <label for="mail">Email <sup>*</sup></label><br /><input type="email"
                                                                                             id="mail"
                                                                                             placeholder="Nhập địa chỉ email để nhận thông tin lịch khám"
                                                                                             value="@Model.Email"
                                                                                             asp-for="@Model.Email"
                                                                                             readonly
                                                                                             style="width: 100%" />
                                    <span class="text-danger" asp-validation-for="Email"></span>

                                </div>
                            }
                            else
                            {
                                <div style="width: 50%">
                                    <label for="mail">Email <sup>*</sup></label><br /><input type="email"
                                                                                             id="mail"
                                                                                             placeholder="Nhập địa chỉ email để nhận thông tin lịch khám"
                                                                                             value="@Model.Email"
                                                                                             asp-for="@Model.Email"
                                                                                             style="width: 100%" />
                                    <span class="text-danger" asp-validation-for="Email"></span>
                                </div>
                            }

                            <div style="width: 50%">
                                <label for="birth">Ngày sinh</label><br /><input type="date"
                                                                                 id="birth"
                                                                                 value="@(Model.DateOfBirth.HasValue ? Model.DateOfBirth.Value.ToString("yyyy-MM-dd") : string.Empty)"
                                                                                 asp-for="@Model.DateOfBirth"
                                                                                 min="@Util.GetUtcPlus7Time().AddYears(-150).ToString("yyyy-MM-dd")"
                                                                                 max="@Util.GetUtcPlus7Time().AddYears(-1).ToString("yyyy-MM-dd")"
                                                                                 placeholder="Vui lòng nhập ngày sinh"
                                                                                 style="width: 100%" />
                            </div>

                            <div style="width: 50%">
                                <label for="province">Tỉnh / Thành phố</label><br />
                                <select id="tinh" title="Chọn Tỉnh Thành" asp-for="@Model.Province">
                                    <option value="0">Tỉnh Thành</option>
                                </select>
                            </div>
                            <div style="width: 25%" class="district">
                                <label for="district">Quận / Huyện</label><br />
                                <select id="quan" title="Chọn Quận Huyện" asp-for="@Model.District">
                                    <option value="0">Quận Huyện</option>
                                </select>
                            </div>
                            <div style="width: 25%" class="ward">
                                <label for="ward">Phường / Xã</label><br />
                                <select id="phuong" title="Chọn Phường Xã" asp-for="@Model.Ward">
                                    <option value="0">Phường Xã</option>
                                </select>
                            </div>

                            <div style="width: 100%" class="address">
                                <label for="address">Địa chỉ</label><br /><input type="text"
                                                                                 id="address"
                                                                                 placeholder="Nhập địa chỉ"
                                                                                 value="@Model.Address"
                                                                                 asp-for="@Model.Address"
                                                                                 style="width: 100%" />
                                <span class="text-danger" asp-validation-for="Address"></span>
                            </div>
                            <div class="submit__button">
                                <button type="reset" class="reset">Nhập lại</button>
                                <button type="submit" class="submit">Lưu</button>
                            </div>
                        </form>
                    </div>
                    @if (User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == false)
                    {
                        <div id="repass" class="tab-pane fade">
                            <h2>Đổi mật khẩu</h2>
                            <div class="repass__content__wrapper">
                                <form asp-action="ChangePassword" method="POST" onsubmit="return window.confirm('Bạn có chắc muốn đổi mật khẩu')">
                                    <div style="width: 100%">
                                        <label for="pass">Mật khẩu</label><br /><input type="password"
                                                                                       name="password"
                                                                                       id="pass"
                                                                                       pattern="^[a-zA-Z][a-zA-Z0-9]*$"
                                                                                       minlength="3"
                                                                                       maxlength="30"
                                                                                       required
                                                                                       placeholder="Nhập mật khẩu"
                                        @(User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == true ? "readonly" : "required")
                                                                                       style="width: 100%" />
                                    </div>
                                    <div style="width: 100%">
                                        <label>Mật khẩu mới</label><br /><input type="password"
                                                                                name="newPassword"
                                                                                id="firstname"
                                                                                pattern="^[a-zA-Z][a-zA-Z0-9]*$"
                                                                                minlength="3"
                                                                                maxlength="30"
                                                                                required
                                                                                placeholder="Nhập mật khẩu mới"
                                        @(User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == true ? "readonly" : "required")
                                                                                style="width: 100%" />
                                    </div>
                                    <div style="width: 100%">
                                        <label>Nhập lại mật khẩu mới</label><br /><input type="password"
                                                                                         name="confirmPassword"
                                                                                         id="firstname"
                                                                                         pattern="^[a-zA-Z][a-zA-Z0-9]*$"
                                                                                         minlength="3"
                                                                                         maxlength="30"
                                                                                         required
                                                                                         placeholder="Nhập lại mật khẩu mới"
                                        @(User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == true ? "readonly" : "required")
                                                                                         style="width: 100%" />
                                    </div>
                                    <div class="submit__button">
                                        <button type="reset" class="reset">Nhập lại</button>
                                        <button type="submit" class="submit" data-bs-toggle="modal"
                                                data-bs-target="#changePassword">
                                            Đổi mật khẩu
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    }

                    @* Lịch sử đặt khám *@
                    <div id="history" class="tab-pane fade">
                        <h2 class="history__filter">
                            Lịch sử đặt khám 
                            <div class="filterStatus">
                                <i class="fa-solid fa-filter"></i> Sắp xếp theo: 
                                <select id="filterStatus">
                                    <option value="all">Tất cả</option>
                                    <option value="Chờ Xác Nhận">Chờ Xác Nhận</option>
                                    <option value="Đã Hủy">Đã Hủy</option>
                                    <option value="Đã Chấp Nhận">Đã Chấp Nhận</option>
                                    <option value="Đã Khám">Đã Khám</option>
                                </select>
                            </div>
                        </h2>
                        <div class="history__management">

                            @if (appointments?.Count > 0)
                            {
                                @foreach (var appointment in appointments)
                                {
                                    @* var currentTime = TimeOnly.FromDateTime(Util.GetUtcPlus7Time()).ToTimeSpan();
                            var startTime = appointment.Schedule.TimeSlot.StartTime.ToTimeSpan();
                            var timeDifference = startTime - currentTime; *@

                                    // Lấy thời gian hiện tại tại Hà Nội
                                    var currentTime = Util.GetUtcPlus7Time();

                                    // Lấy thời gian bắt đầu của cuộc hẹn
                                    var appointmentDate = appointment.Schedule.Date; // Ngày hẹn
                                    var appointmentStartTime = appointment.Schedule.TimeSlot.StartTime; // Thời gian bắt đầu hẹn
                                    var appointmentDateTime = new DateTime(appointmentDate.Year, appointmentDate.Month, appointmentDate.Day, appointmentStartTime.Hour, appointmentStartTime.Minute, 0);

                                    // Tính toán sự khác biệt thời gian giữa thời gian hiện tại và thời gian bắt đầu cuộc hẹn
                                    var timeDifference = appointmentDateTime - currentTime;

                                    @* Console.WriteLine("=================================================");
                            // Ghi log hoặc hiển thị giá trị để kiểm tra
                            Console.WriteLine($"Current Time: {currentTime}");
                            Console.WriteLine($"Appointment Start Time: {appointmentDateTime}");
                            Console.WriteLine($"Time Difference (Hours): {timeDifference.TotalHours}");

                            var showRescheduleButton = timeDifference.TotalHours >= 7;
                            Console.WriteLine($"Show Reschedule Button: {showRescheduleButton}");
                            Console.WriteLine("================================================="); *@


                                    <div class="appointment-card" id="appointment-card" style="border: 1px solid #1376f8; border-radius: 8px; padding: 16px; margin-bottom: 16px; background-color: #fff;">
                                        <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
                                            <div class="code" style="font-weight: bold; color: #007bff;">@index</div>
                                            <div class="status" id="statusCheck" style="
                                                color: white;
                                                font-weight: bold;
                                                width: 30%;
                                                text-align: center;
                                                border-radius: 4px;
                                                padding: 4px;
                                                background:
                                                @(
                                                    appointment?.AppointmentStatus == "Đã Khám" ? "#90ee90" :
                                                    appointment?.AppointmentStatus == "Chờ Xác Nhận" ? "#ffc107" :
                                                    appointment?.AppointmentStatus == "Đã Chấp Nhận" ? "#17a2b8" :
                                                    appointment?.AppointmentStatus == "Đã Hủy" ? "#ff474d" : ""
                                                );">
                                                @appointment?.AppointmentStatus
                                            </div>
                                        </div>
                                        <div class="body" style="margin-top: 16px;">
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-weight: bold; white-space: nowrap; margin-right: 8px; min-width: 180px;">Bệnh nhân:</span>
                                                <span style="flex-grow: 1;">@appointment?.PatientRecords?.FullName</span>
                                            </div>
                                            <hr>
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="flex-grow: 1; font-weight: bold; color: #1376f8; white-space: nowrap;"><i class="fas fa-clinic-medical"></i> @appointment?.Schedule?.Dentist?.Clinic.Name</span>
                                            </div>
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="flex-grow: 1; font-weight: bold; color: #1376f8;">
                                                    <i class="fa-solid fa-location-dot"></i>
                                                    @appointment?.Schedule?.Dentist?.Clinic.Address,
                                                    @appointment?.Schedule?.Dentist?.Clinic.WardName,
                                                    @appointment?.Schedule?.Dentist?.Clinic.DistrictName,
                                                    @appointment?.Schedule?.Dentist?.Clinic.ProvinceName
                                                </span>

                                            </div>
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-weight: bold; white-space: nowrap; margin-right: 8px; min-width: 180px;">Nha sĩ:</span>
                                                <span style="flex-grow: 1;">@appointment?.Schedule?.Dentist?.Account?.LastName @appointment?.Schedule?.Dentist?.Account?.FirstName</span>
                                            </div>
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-weight: bold; white-space: nowrap; margin-right: 8px; min-width: 180px;">Chuyên Khoa:</span>
                                                <span style="flex-grow: 1;">@appointment?.Specialty?.Name</span>
                                            </div>
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-weight: bold; white-space: nowrap; margin-right: 8px; min-width: 180px;">Ngày đặt:</span>
                                                <span style="flex-grow: 1;">@(appointment.CreatedDate.HasValue ? appointment.CreatedDate.Value.ToString("dd-MM-yyyy") : "N/A")</span>
                                            </div>
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-weight: bold; white-space: nowrap; margin-right: 8px; min-width: 180px;">Ngày hẹn:</span>
                                                <span style="flex-grow: 1;">@appointment?.Schedule?.Date.ToString("dd-MM-yyyy")</span>
                                            </div>
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-weight: bold; white-space: nowrap; margin-right: 8px; min-width: 180px;">Giờ hẹn:</span>
                                                <span style="flex-grow: 1;">@appointment?.Schedule?.TimeSlot?.StartTime.ToString("HH:mm") - @appointment?.Schedule?.TimeSlot?.EndTime.ToString("HH:mm")</span>
                                            </div>
                                            <div class="item" style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-weight: bold; white-space: nowrap; margin-right: 8px; min-width: 180px;">Giá tiền:</span>
                                                <span style="flex-grow: 1;">@string.Format(new CultureInfo("vi-VN"), "{0:#,##0.} đ", appointment?.TotalPrice)</span>
                                                @switch (appointment?.AppointmentStatus)
                                                {
                                                    case "Đã Hủy":

                                                        break;
                                                    case "Đã Khám":

                                                        if (appointment.IsRated == "Đã Đánh Giá")
                                                        {
                                                            <div class="btn btn-success" style="padding: 10px 20px; font-size: 16px; border-radius: 8px; font-weight: bold;">
                                                                Đã Đánh Giá
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <button type="button" class="btn btn-success" style="padding: 10px 20px; font-size: 16px; border-radius: 8px; font-weight: bold;" data-bs-toggle="modal" data-bs-target="#ratingModal" data-clinic-id="@appointment?.Schedule?.Dentist?.Clinic.ID" data-dentist-id="@appointment?.Schedule?.Dentist.ID" data-patient-id="@appointment?.PatientRecords?.Account?.ID" data-appointment-id="@appointment?.ID">
                                                                Đánh Giá
                                                            </button>
                                                        }

                                                        break;
                                                    case "Chờ Xác Nhận":
                                                        @if (timeDifference.TotalHours >= 7)
                                                        {
                                                            <button type="button" class="btn btn-warning pendingButton" style="padding: 10px 20px; font-size: 16px; border-radius: 8px; font-weight: bold; margin-right: 1rem;" data-bs-toggle="modal" data-bs-target="#rescheduleModal" data-dentist-id="@appointment?.Schedule?.Dentist?.ID" data-appointment-id="@appointment?.ID">
                                                                Đổi lịch khám
                                                            </button>
                                                        }

                                                        <form asp-area="" asp-controller="Account" asp-action="CancelAppointment" method="post" style="margin-left: auto;" onsubmit="return confirmCancel();">
                                                            <input type="hidden" name="appointmentID" value="@appointment?.ID" />
                                                            <input type="hidden" name="scheduleID" value="@appointment?.Schedule?.ID" />
                                                            <input type="hidden" name="appointmentStatus" value="Đã Hủy" />
                                                            <button type="submit" class="btn btn-danger" style="padding: 10px 20px; font-size: 16px; border-radius: 8px; font-weight: bold;">
                                                                Hủy khám
                                                            </button>
                                                        </form>
                                                        break;
                                                    case "Đã Chấp Nhận":
                                                        @if (timeDifference.TotalHours >= 7)
                                                        {
                                                            <button type="button" class="btn btn-warning pendingButton" style="padding: 10px 20px; font-size: 16px; border-radius: 8px; font-weight: bold; margin-right: 1rem;" data-bs-toggle="modal" data-bs-target="#rescheduleModal" data-dentist-id="@appointment?.Schedule?.Dentist?.ID" data-appointment-id="@appointment?.ID">
                                                                Đổi lịch khám
                                                            </button>
                                                        }

                                                        <form asp-area="" asp-controller="Account" asp-action="CancelAppointment" method="post" style="margin-left: auto;">
                                                            <input type="hidden" name="appointmentID" value="@appointment.ID" />
                                                            <input type="hidden" name="appointmentStatus" value="Đã Hủy" />
                                                            <button type="submit" class="btn btn-danger" style="padding: 10px 20px; font-size: 16px; border-radius: 8px; font-weight: bold;">
                                                                Hủy khám
                                                            </button>
                                                        </form>
                                                        break;
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    index++;
                                }
                            }
                            else
                            {
                                <div class="history__container__style" id="history__container__style">
                                    <span>Bạn chưa có lịch khám nào</span>
                                    <span>
                                        <img src="https://medpro.vn/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FEmptyList.a1f0b7f8.png&w=640&q=75"
                                             alt="" />
                                    </span>
                                </div>
                            }


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Rating Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 700px; margin: 1.75rem auto;">
            <div class="modal-content" style="padding: 20px;">
                <div class="modal-header" style="justify-content: center;">
                    <h5 class="modal-title" id="ratingModalLabel" style="font-size: 2rem;">Đánh Giá Phòng Khám</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="position: absolute; right: 2.5rem; font-size: 1.5rem;"></button>
                </div>
                <div class="modal-body" style="display: flex; flex-direction: column; align-items: center;">
                    <form id="ratingForm" asp-action="RateAppointment" method="post" style="width: 100%;">
                        <input type="hidden" name="appointmentID" id="appointmentIdInput" />
                        <input type="hidden" name="clinicID" id="clinicIdInput" />
                        <input type="hidden" name="dentistID" id="dentistIdInput" />
                        <input type="hidden" name="patientID" id="patientIdInput" />
                        <div class="rating" style="margin-bottom: 20px; display: flex; justify-content: center; align-items: center;">
                            <span class="star" data-value="1" style="font-size: 3.5rem; cursor: pointer; color: #e4e5e9; margin: 0 5px;">&#9733;</span>
                            <span class="star" data-value="2" style="font-size: 3.5rem; cursor: pointer; color: #e4e5e9; margin: 0 5px;">&#9733;</span>
                            <span class="star" data-value="3" style="font-size: 3.5rem; cursor: pointer; color: #e4e5e9; margin: 0 5px;">&#9733;</span>
                            <span class="star" data-value="4" style="font-size: 3.5rem; cursor: pointer; color: #e4e5e9; margin: 0 5px;">&#9733;</span>
                            <span class="star" data-value="5" style="font-size: 3.5rem; cursor: pointer; color: #e4e5e9; margin: 0 5px;">&#9733;</span>
                        </div>
                        <input type="hidden" name="rating" id="ratingInput" />

                        <div class="form-group" style="width: 100%; margin-top: 20px;">
                            <label for="comment" style="font-size: large;">Nhận xét:</label>
                            <textarea class="form-control" name="comment" id="comment" rows="10" style="width: 100%; font-size: 2rem;"></textarea>
                        </div>
                        <div class="modal-footer" style="margin-top: 20px; border-top: 0;">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px; font-size: 1.5rem;">Đóng</button>
                            <button type="submit" class="btn btn-primary" style="padding: 10px 20px; font-size: 1.5rem;">Gửi đánh giá</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Reschedule Modal -->
    <div class="modal fade" id="rescheduleModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" style="max-width: 50% !important">
            <div class="modal-content">
                <div class="modal-header" style="justify-content: center; border: 0; color: #fff;
    padding: 12px 16px;
    background: linear-gradient(36deg, #00b5f1, #00e0ff);
    font-size: 2rem;
    font-weight: 500;
    line-height: normal;
    text-align: center;">
                    <div>
                        <h3 class="modal-title" id="rescheduleModalLabel">Đổi Lịch Khám</h3>
                    </div>
                    @* <div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div> *@
                </div>
                <div class="modal-body">
                    <form id="rescheduleForm" asp-controller="Account" asp-action="RescheduleAppointment" method="post">

                        <input type="hidden" name="bookingDateTime" id="bookingDateTime" />
                        <input type="hidden" name="appointmentID" id="appointmentID" />

                        <!-- THẺ NÀY ĐỂ HIỂN THỊ LỊCH THEO GIAO DIỆN MOBISCROLL  -->
                        <div class="mbsc-col-sm-12 mbsc-col-md-4">
                            <div class="mbsc-form-group">
                                <div id="demo-single-day"></div>
                            </div>
                        </div>



                        <div class="modal-footer" style="border: 0;">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 1.5rem;">Đóng</button>
                            <button type="submit" class="btn btn-primary" style="font-size: 1.5rem;" id="saveButton" disabled>Lưu thay đổi</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="~/assets/js/mobiscroll.javascript.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            mobiscroll.setOptions({
                stepMinute: 30,
                theme: "ios",
                themeVariant: "light"
            });

            // var dentistId = button.data('dentist-id');
            document.querySelectorAll('.pendingButton').forEach(button => {
                button.addEventListener('click', (hello) => {
                    const dentistId = hello.currentTarget.getAttribute('data-dentist-id');
                    const appointmentId = hello.currentTarget.getAttribute('data-appointment-id');
                    // document.getElementById('appointmentID').textContent = appointmentId;
                    document.getElementById('appointmentID').value = appointmentId;
                    console.log(appointmentId);
                    console.log(dentistId);
                    //fetch schedules from the server
                    fetch('/clinic/getschedules?dentistID=' + dentistId)
                        .then(response => response.json())
                        .then(data => {
                            // map the data to the mobiscroll valid format
                            var schedules = data.map(function (item) {
                                return {
                                    start: item.date + 'T' + item.startTime,
                                    end: item.date + 'T' + item.startTime,
                                    title: item.scheduleID,
                                    recurring: {
                                        repeat: 'none'
                                    }
                                };
                            });

                            var scheduleMap = new Map();
                            data.forEach(function (item) {
                                scheduleMap.set(item.date + 'T' + item.startTime, item.date + " " + item.startTime + " " + item.endTime);
                            });
                            //console.log(schedules);
                            console.log(scheduleMap);

                            // let current = new Date();
                            //initialize mobiscroll calendar with the valid dates
                            mobiscroll.datepicker("#demo-single-day", {
                                controls: ["calendar", "timegrid"],
                                firstDay: 1,
                                //min: current.setHours(current.getHours() + 4),
                                display: "inline",
                                touchUI: true,
                                selectMultiple: false,
                                valid: schedules.map(item => ({
                                    start: item.start,
                                    end: item.end,
                                })),

                                locale: mobiscroll.localeVi,

                                onChange: function (event, inst) {
                                    console.log(formatDate(event.value));
                                    //Lấy ngày + thời gian từ event và gán vào input hidden
                                    document.getElementById('bookingDateTime').value = scheduleMap.get(formatDate(event.value));
                                    //Ẩn hoặc hiện button submit theo giá trị scheduleID
                                    if (document.getElementById('bookingDateTime').value === '' || document.getElementById('bookingDateTime').value === 'undefined') {
                                        document.getElementById('saveButton').disabled = true;
                                    }
                                    else {
                                        document.getElementById('saveButton').disabled = false;
                                    }
                                }
                            });

                        })
                        .catch(error => {
                            alert('Không tải được lịch tương ứng!');
                            console.error('error:', error);
                        });
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            var filterStatusSelect = document.getElementById('filterStatus');

            filterStatusSelect.addEventListener('change', function () {
                var selectedStatus = filterStatusSelect.value;
                var appointmentCards = document.querySelectorAll('.appointment-card');

                appointmentCards.forEach(function (card) {
                    var statusCheck = card.querySelector('#statusCheck').textContent.trim();

                    if (selectedStatus === "all" || statusCheck === selectedStatus) {
                        card.style.display = ''; // Hiển thị thẻ nếu trùng khớp hoặc không có bộ lọc
                        card.classList.add('fade-in');
                    } else {
                        card.classList.remove('fade-in');
                        card.style.display = 'none'; // Ẩn thẻ nếu không trùng khớp
                    }
                });
            });
        });

        // Hàm này nhận value của ngày trong event và trả về theo định dạng
        function formatDate(date) {
            const pad = (number) => (number < 10 ? '0' : '') + number;
            const day = pad(date.getDate());
            const month = pad(date.getMonth() + 1); // Months are zero-based
            const year = date.getFullYear();
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
    </script>




    <script>
        $(document).ready(function () {
            $('#ratingModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var clinicId = button.data('clinic-id');
                var dentistId = button.data('dentist-id');
                var patientId = button.data('patient-id');
                var appointmentId = button.data('appointment-id');
                var modal = $(this);
                modal.find('#clinicIdInput').val(clinicId);
                modal.find('#dentistIdInput').val(dentistId);
                modal.find('#patientIdInput').val(patientId);
                modal.find('#appointmentIdInput').val(appointmentId);
            });

            $('.star').click(function () {
                var rating = $(this).data('value');
                $('#ratingInput').val(rating);
                $('.star').each(function () {
                    if ($(this).data('value') <= rating) {
                        $(this).css('color', '#ffc107');
                    } else {
                        $(this).css('color', '#e4e5e9');
                    }
                });
            });
        });
    </script>

    <script>
        function confirmCancel() {
            return confirm("Xác nhận hủy khám?");
        }
    </script>

    @* Call API from https://esgoo.net to get data*@
    <script src="https://esgoo.net/scripts/jquery.js"></script>
    <script>
        $(document).ready(function () {
            var savedProvince = '@Model.Province';
            var savedDistrict = '@Model.District';
            var savedWard = '@Model.Ward';

            // Function to format ID with leading zeros based on the length requirement
            function formatId(id, length) {
                return id.toString().padStart(length, '0');
            }

            var savedProvinceId = savedProvince ? formatId(parseInt(savedProvince, 10), 2) : null;
            var savedDistrictId = savedDistrict ? formatId(parseInt(savedDistrict, 10), 3) : null;
            var savedWardId = savedWard ? formatId(parseInt(savedWard, 10), 5) : null;

            function loadWards(idquan, callback) {
                var formattedId = formatId(idquan, 3);
                $.getJSON('https://esgoo.net/api-tinhthanh/3/' + formattedId + '.htm', function (data_phuong) {
                    if (data_phuong.error == 0) {
                        $("#phuong").html('<option value="0">Phường Xã</option>');
                        $.each(data_phuong.data, function (key_phuong, val_phuong) {
                            var selected = (val_phuong.id == savedWardId) ? ' selected' : '';
                            $("#phuong").append('<option value="' + val_phuong.id + '" data-fullname="' + val_phuong.full_name + '"' + selected + '>' + val_phuong.full_name + '</option>');
                        });

                        if (callback) {
                            callback();
                        }
                    }
                });
            }

            function loadDistricts(idtinh, callback) {
                var formattedId = formatId(idtinh, 2);
                $.getJSON('https://esgoo.net/api-tinhthanh/2/' + formattedId + '.htm', function (data_quan) {
                    if (data_quan.error == 0) {
                        $("#quan").html('<option value="0">Quận Huyện</option>');
                        $("#phuong").html('<option value="0">Phường Xã</option>');
                        $.each(data_quan.data, function (key_quan, val_quan) {
                            var selected = (val_quan.id == savedDistrictId) ? ' selected' : '';
                            $("#quan").append('<option value="' + val_quan.id + '" data-fullname="' + val_quan.full_name + '"' + selected + '>' + val_quan.full_name + '</option>');
                        });

                        if (savedDistrictId) {
                            loadWards(savedDistrictId, callback);
                        } else if (callback) {
                            callback();
                        }
                    }
                });
            }

            function loadProvinces(callback) {
                $.getJSON('https://esgoo.net/api-tinhthanh/1/0.htm', function (data_tinh) {
                    if (data_tinh.error == 0) {
                        $("#tinh").html('<option value="0">Tỉnh Thành</option>');
                        $.each(data_tinh.data, function (key_tinh, val_tinh) {
                            var selected = (val_tinh.id == savedProvinceId) ? ' selected' : '';
                            $("#tinh").append('<option value="' + val_tinh.id + '" data-fullname="' + val_tinh.full_name + '"' + selected + '>' + val_tinh.full_name + '</option>');
                        });

                        if (savedProvinceId) {
                            loadDistricts(savedProvinceId, callback);
                        } else if (callback) {
                            callback();
                        }
                    }
                });
            }

            function setInitialValues() {
                if (savedProvinceId) {
                    $("#tinh").val(savedProvinceId);
                    $("#tinh").trigger('change');
                }
                if (savedDistrictId) {
                    $("#quan").val(savedDistrictId);
                    $("#quan").trigger('change');
                }
                if (savedWardId) {
                    $("#phuong").val(savedWardId);
                }
            }

            loadProvinces(setInitialValues);

            $("#tinh").change(function (e) {
                var selectedOption = $(this).find('option:selected');
                var idtinh = selectedOption.val();
                var fullnameTinh = selectedOption.data('fullname');
                $('#Province').val(fullnameTinh);

                // Load districts based on selected province
                loadDistricts(idtinh);
            });

            $("#quan").change(function (e) {
                var selectedOption = $(this).find('option:selected');
                var idquan = selectedOption.val();
                var fullnameQuan = selectedOption.data('fullname');
                $('#District').val(fullnameQuan);

                // Load wards based on selected district
                loadWards(idquan);
            });

            $("#phuong").change(function (e) {
                var selectedOption = $(this).find('option:selected');
                var fullnamePhuong = selectedOption.data('fullname');
                $('#Ward').val(fullnamePhuong);
            });
        });
    </script>
</body>
